#include <stdio.h>
#include <fcntl.h>
#include <termios.h>
#include <unistd.h>
#include <stdint.h>

int main() {
    // ==========================================
    // Debug Mode settings
    // ==========================================
    // DEBUG_LEVEL = 0 : Normal mode
    // DEBUG_LEVEL = 1 : Read controller data and write out in console
    // DEBUG_LEVEL = 2 : write out CRSF frame data to console

    #define DEBUG_LEVEL 0

    // ==========================================
    // UART: ELRS connection serial port (B460800)
    // ==========================================
    const char* portname = "/dev/ttyACM0";
    int fd = open(portname, O_RDWR | O_NOCTTY);
    printf("Port %s opened successfully (fd=%d)\n", portname, fd);
    if (fd < 0) { perror("open"); return 1; }

    struct termios options;
    tcgetattr(fd, &options);
    cfsetispeed(&options, B460800);
    cfsetospeed(&options, B460800);
    options.c_cflag &= ~PARENB; // no parity
    options.c_cflag &= ~CSTOPB; // 1 stop bit
    options.c_cflag &= ~CSIZE;
    options.c_cflag |= CS8;     // 8 data bits
    tcsetattr(fd, TCSANOW, &options);

    // Pitch
    int ad0_trim[4] = {34616, 990, 109, 102};

    // Roll
    int ad1_trim[4] = {34936, 990, 126, 110};

    // Throttle
    int ad2_trim[4] = {33208, 1050, 108, 115};

    // Yaw
    int ad3_trim[4] = {33736, 990, 115, 120};

    // Channel data buffer
    int tx_channels[16] = {0};

    // ===============================
    // CRC table
    // ===============================
    uint8_t crc_data[256] = {
        0x00,0xD5,0x7F,0xAA,0xFE,0x2B,0x81,0x54,0x29,0xFC,0x56,0x83,0xD7,0x02,0xA8,0x7D,
        0x52,0x87,0x2D,0xF8,0xAC,0x79,0xD3,0x06,0x7B,0xAE,0x04,0xD1,0x85,0x50,0xFA,0x2F,
        0xA4,0x71,0xDB,0x0E,0x5A,0x8F,0x25,0xF0,0x8D,0x58,0xF2,0x27,0x73,0xA6,0x0C,0xD9,
        0xF6,0x23,0x89,0x5C,0x08,0xDD,0x77,0xA2,0xDF,0x0A,0xA0,0x75,0x21,0xF4,0x5E,0x8B,
        0x9D,0x48,0xE2,0x37,0x63,0xB6,0x1C,0xC9,0xB4,0x61,0xCB,0x1E,0x4A,0x9F,0x35,0xE0,
        0xCF,0x1A,0xB0,0x65,0x31,0xE4,0x4E,0x9B,0xE6,0x33,0x99,0x4C,0x18,0xCD,0x67,0xB2,
        0x39,0xEC,0x46,0x93,0xC7,0x12,0xB8,0x6D,0x10,0xC5,0x6F,0xBA,0xEE,0x3B,0x91,0x44,
        0x6B,0xBE,0x14,0xC1,0x95,0x40,0xEA,0x3F,0x42,0x97,0x3D,0xE8,0xBC,0x69,0xC3,0x16,
        0xEF,0x3A,0x90,0x45,0x11,0xC4,0x6E,0xBB,0xC6,0x13,0xB9,0x6C,0x38,0xED,0x47,0x92,
        0xBD,0x68,0xC2,0x17,0x43,0x96,0x3C,0xE9,0x94,0x41,0xEB,0x3E,0x6A,0xBF,0x15,0xC0,
        0x4B,0x9E,0x34,0xE1,0xB5,0x60,0xCA,0x1F,0x62,0xB7,0x1D,0xC8,0x9C,0x49,0xE3,0x36,
        0x19,0xCC,0x66,0xB3,0xE7,0x32,0x98,0x4D,0x30,0xE5,0x4F,0x9A,0xCE,0x1B,0xB1,0x64,
        0x72,0xA7,0x0D,0xD8,0x8C,0x59,0xF3,0x26,0x5B,0x8E,0x24,0xF1,0xA5,0x70,0xDA,0x0F,
        0x20,0xF5,0x5F,0x8A,0xDE,0x0B,0xA1,0x74,0x09,0xDC,0x76,0xA3,0xF7,0x22,0x88,0x5D,
        0xD6,0x03,0xA9,0x7C,0x28,0xFD,0x57,0x82,0xFF,0x2A,0x80,0x55,0x01,0xD4,0x7E,0xAB,
        0x84,0x51,0xFB,0x2E,0x7A,0xAF,0x05,0xD0,0xAD,0x78,0xD2,0x07,0x53,0x86,0x2C,0xF9
    };

    // CRSF frame
    uint8_t ch_data[26] = {
    0xEE,0x18,0x16,0xD2,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00
    };

    uint8_t ch_data_byte[26] = {
    0xEE,0x18,0x16,0xD2,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00
    };

    uint8_t Power0_data[8] = {0xEE, 0x06, 0x2D, 0xEE, 0xEF, 0x06, 0x00, 0xF1};
    uint8_t Power1_data[8] = {0xEE, 0x06, 0x2D, 0xEE, 0xEF, 0x06, 0x01, 0x24};
    uint8_t Power2_data[8] = {0xEE, 0x06, 0x2D, 0xEE, 0xEF, 0x06, 0x02, 0x8E};
    uint8_t Power3_data[8] = {0xEE, 0x06, 0x2D, 0xEE, 0xEF, 0x06, 0x03, 0x5B};
    uint8_t Power4_data[8] = {0xEE, 0x06, 0x2D, 0xEE, 0xEF, 0x06, 0x04, 0x0F};
    uint8_t Power5_data[8] = {0xEE, 0x06, 0x2D, 0xEE, 0xEF, 0x06, 0x05, 0xDA};
    
    // channel for each swich level
    uint16_t SW_L = 200;   
    uint16_t SW_M = 1000;  
    uint16_t SW_H = 1700;   

    printf("*** Start Nano TX AUX LED Test ***\n");

    write(fd, Power0_data, sizeof(Power0_data));
    usleep(100000);
    write(fd, Power1_data, sizeof(Power1_data));
    usleep(100000);

    while (1) {
        // AUX1をLOWにセットして送信
        ch_data[3] = SW_L & 0xFF;
        ch_data[4] = (SW_L >> 8) & 0xFF;
        write(fd, ch_data, sizeof(ch_data));
        printf("AUX1 = LOW\n");
        usleep(500000); // 0.5秒

        // AUX1をHIGHにセットして送信
        ch_data[3] = SW_H & 0xFF;
        ch_data[4] = (SW_H >> 8) & 0xFF;
        write(fd, ch_data, sizeof(ch_data));
        printf("AUX1 = HIGH\n");
        usleep(500000); // 0.5秒
    }

    close(fd);
    return 0;
}
